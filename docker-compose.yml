# DEVision Job Applicant - Docker Compose
# Architecture: Ultimo Level with API Gateway and Service Discovery
# Requirements: D.2.1, D.3.1, D.3.3

services:
  # ==============================================
  # API Gateway (Kong) - Per requirement D.3.1
  # Hosted separately from frontend/backend per D.3.3
  # ==============================================
  kong:
    image: kong:3.4
    container_name: JA_kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
    volumes:
      - ./gateway/kong.yml:/kong/kong.yml:ro
    ports:
      - "8000:8000" # Proxy port (API Gateway endpoint)
      - "8001:8001" # Admin API port
    depends_on:
      - backend
    networks:
      - devision-network
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==============================================
  # Service Discovery (Consul) - Per requirement D.3.1
  # Hosted separately from frontend/backend per D.3.3
  # ==============================================
  consul:
    image: hashicorp/consul:1.17
    container_name: JA_consul
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -config-file=/consul/config/config.json
    volumes:
      - ./consul/config.json:/consul/config/config.json:ro
      - consul_data:/consul/data
    ports:
      - "8500:8500" # HTTP API and UI
      - "8600:8600/udp" # DNS interface
    networks:
      - devision-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==============================================
  # Backend Service (Spring Boot)
  # ==============================================
  backend:
    build: ./backend
    container_name: JA_backend
    ports:
      - "8080:8080"
    env_file:
      - ./backend/.env
    depends_on:
      redis:
        condition: service_started
    environment:
      # Kafka config read from .env file (Confluent Cloud - D.3.2)
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Service Discovery registration
      SERVICE_NAME: ja-backend
      CONSUL_HOST: consul
      CONSUL_PORT: 8500
    networks:
      - devision-network
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==============================================
  # Frontend Service (React)
  # ==============================================
  frontend:
    build: ./JA_frontend/
    container_name: JA_frontend
    ports:
      - "3000:3000"
    env_file:
      - ./JA_frontend/.env
    depends_on:
      - kong
    environment:
      # Route API calls through Kong Gateway
      REACT_APP_API_GATEWAY_URL: http://localhost:8000
    networks:
      - devision-network

  # ==============================================
  # Message Broker (Kafka) - Using Confluent Cloud
  # Per requirement A.3.2, D.3.2 - Hosted externally
  # Confluent Cloud: pkc-921jm.us-east-2.aws.confluent.cloud:9092
  # ==============================================
  # NOTE: Local Kafka removed - using Confluent Cloud instead
  # Config in backend/.env: KAFKA_BOOTSTRAP_SERVERS, KAFKA_SECURITY_PROTOCOL, etc.

  # ==============================================
  # Cache & Token Store (Redis) - Per requirement 2.3.2
  # ==============================================
  redis:
    image: redis:7-alpine
    container_name: JA_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - devision-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# ==============================================
# Networks - Isolated network for all services
# ==============================================
networks:
  devision-network:
    driver: bridge
    name: devision-network

# ==============================================
# Volumes - Persistent data storage
# ==============================================
volumes:
  redis_data:
  consul_data:
