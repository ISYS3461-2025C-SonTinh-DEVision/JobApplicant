#!/bin/bash
# DEVision Job Applicant - Cloud Deployment Script
# Deploys all services to DigitalOcean droplets by cloning repo and building

set -e

echo "=== DEVision Cloud Deployment ==="
echo ""

# Droplet IPs
GATEWAY_IP="YOUR_GATEWAY_IP"
APP_IP="YOUR_APP_IP"
KAFKA_IP="YOUR_KAFKA_IP"

# GitHub repo
REPO="https://github.com/YOUR_ORG/YOUR_REPO.git"
BRANCH="main"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# IMPORTANT: Load credentials from secure source (e.g., environment variables, secrets manager)
# NEVER hardcode credentials in this file
if [ -z "$MONGODB_URI" ] || [ -z "$GOOGLE_CLIENT_SECRET" ]; then
  echo -e "${RED}ERROR: Required environment variables not set${NC}"
  echo "Please set the following environment variables:"
  echo "  - MONGODB_URI"
  echo "  - GOOGLE_CLIENT_SECRET"
  echo "  - CLOUDINARY_API_SECRET"
  echo "  - MAIL_PASSWORD"
  echo "  - JOB_MANAGER_SERVICE_PASSWORD"
  exit 1
fi

echo -e "${YELLOW}Step 1: Deploying Kafka (Message Broker) to $KAFKA_IP${NC}"
ssh -o StrictHostKeyChecking=no root@$KAFKA_IP << EOF
  echo "Cleaning up..."
  rm -rf /opt/devision
  mkdir -p /opt/devision
  cd /opt/devision
  
  echo "Creating Kafka docker-compose..."
  cat > docker-compose.yml << 'COMPOSE'
services:
  kafka:
    image: apache/kafka:latest
    container_name: JA_kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://$KAFKA_IP:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    volumes:
      - kafka_data:/var/lib/kafka/data
volumes:
  kafka_data:
COMPOSE

  docker compose down 2>/dev/null || true
  docker compose up -d
  echo "Kafka started on port 9092!"
EOF
echo -e "${GREEN}✓ Kafka deployed${NC}"
echo ""

echo -e "${YELLOW}Step 2: Deploying Application to $APP_IP${NC}"
ssh -o StrictHostKeyChecking=no root@$APP_IP << EOF
  echo "Cleaning up..."
  rm -rf /opt/devision
  mkdir -p /opt/devision
  cd /opt/devision
  
  echo "Cloning repository..."
  git clone --depth 1 --branch $BRANCH $REPO repo
  cd repo
  
  echo "Creating production env files from environment variables..."
  cat > backend/.env << ENVFILE
MONGODB_URI=$MONGODB_URI
JOB_MANAGER_BASE_URL=$JOB_MANAGER_BASE_URL
JOB_MANAGER_SERVICE_URL=$JOB_MANAGER_SERVICE_URL
JOB_MANAGER_SERVICE_EMAIL=$JOB_MANAGER_SERVICE_EMAIL
JOB_MANAGER_SERVICE_PASSWORD=$JOB_MANAGER_SERVICE_PASSWORD
SERVER_PORT=8080
FRONTEND_BASE_URL=$FRONTEND_BASE_URL
BACKEND_BASE_URL=$BACKEND_BASE_URL
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=$REDIS_PASSWORD
CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
MAIL_USERNAME=$MAIL_USERNAME
MAIL_PASSWORD=$MAIL_PASSWORD
MAIL_FROM=$MAIL_FROM
ENVFILE

  cat > JA_frontend/.env << ENVFILE
REACT_APP_API_URL=$FRONTEND_BASE_URL
REACT_APP_API_GATEWAY_URL=$FRONTEND_BASE_URL
REACT_APP_GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
REACT_APP_CONSUL_URL=http://$GATEWAY_IP:8500
REACT_APP_DEBUG=false
ENVFILE

  echo "Starting Docker containers..."
  docker compose -f docker-compose.prod.yml down 2>/dev/null || true
  docker compose -f docker-compose.prod.yml up -d --build
  
  echo "Application deployed!"
EOF

echo -e "${GREEN}✓ Application deployed${NC}"
echo ""
echo -e "${GREEN}=== Deployment Complete ===${NC}"
echo "Services:"
echo "  - Kafka: $KAFKA_IP:9092"
echo "  - Backend: $APP_IP:8080"
echo "  - Frontend: $APP_IP:3000"
echo "  - Gateway: $GATEWAY_IP:8000"
echo "  - Consul: $GATEWAY_IP:8500"
